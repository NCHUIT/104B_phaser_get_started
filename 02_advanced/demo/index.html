<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Phaser demo</title>
</head>
<body style="margin:0;">
  <div id="game"></div>
  <script src="//code.jquery.com/jquery-1.12.0.min.js" charset="utf-8"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/phaser/2.4.6/phaser.min.js" charset="utf-8"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" charset="utf-8"></script>
  <script type="text/javascript">

    var game = {
      new: function(witdh, height, canvas_selector){
        this.phaser = new Phaser.Game(witdh, height, Phaser.AUTO, canvas_selector, this)
      },
      preload: function(){
        var phaser = this.phaser;
        game.phaser.load.crossOrigin = true;

        phaser.load.image('logo','http://i.imgur.com/SSSWhXx.png');

        phaser.load.tilemap('map', 'tilemap/map.json', null, Phaser.Tilemap.TILED_JSON);
        phaser.load.image('kenney', 'tilemap/kenney.png');

        phaser.load.atlas('tank', 'img/tanks.png', 'assets/tanks.json');
        phaser.load.image('bullet', 'img/bullet.png');
        phaser.load.image('earth', 'img/scorched_earth.png');
        phaser.load.spritesheet('kaboom', 'img/explosion.png', 64, 64, 23);
      },
      create: function(){
        var phaser = this.phaser;

        // Prepare how the world works
        phaser.physics.startSystem(Phaser.Physics.ARCADE);
        // phaser.physics.startSystem(Phaser.Physics.ARCADE);

        // The land
        this.land = phaser.add.tileSprite(0, 0, phaser.scale.width, phaser.scale.height, 'earth');
        this.land.fixedToCamera = true;

        // Our tank group
        var tank_group = phaser.add.group();

        // Our tank body
        var tank = this.add.sprite(50, 50, 'tank', 'tank');
        tank.anchor.setTo(0.5, 0.5);
        phaser.physics.enable(tank);
        tank.body.maxVelocity.setTo(400, 400);
        tank.body.collideWorldBounds = true;
        tank.currentSpeed = 0;
        phaser.camera.follow(tank);

        // Our tank group
        tank_group.add(tank);
        this.tank = tank;

       //  Our ships bullets
        bullets = game.add.group();
        bullets.enableBody = true;
        bullets.physicsBodyType = Phaser.Physics.ARCADE;

        // // The turret on our tank
        var turret = phaser.add.sprite(0, 0, 'tank', 'turret')
        turret.anchor.setTo(0.3, 0.5);
        tank_group.add(turret)
        //  A shadow below our tank
        var shadow = this.add.sprite(0, 0, 'tank', 'shadow');
        shadow.anchor.setTo(0.5, 0.5);
        tank_group.add(shadow)

        // fix z layer of our tank
        tank.bringToTop();
        turret.bringToTop();

        // expose tank component to the game instance
        this.tank_group = tank_group;
        this.tank = tank;
        this.turret = turret;

        // add the map
        var map = phaser.add.tilemap('map');
        map.addTilesetImage('kenney');

        // set collision properties
        var map_tileproperties = phaser.cache.getTilemapData('map').data.tilesets[0].tileproperties;
        var map_collision_tiles = _.reduce(map_tileproperties, function(memo, v, k){
          if(v.slope === undefined) return memo;
          else return memo.concat(parseInt(k) + 1);
        },[])
        map.setCollision(map_collision_tiles);

        // make the collision layer from the map
        var layer = map.createLayer('layer1');
        layer.resizeWorld(); // set the world size according to the map
        this.layer = layer;

        // The Cat Logo
        var logo = phaser.add.sprite(0, 0, 'logo');
        logo.x = phaser.scale.width / 2;
        logo.y = phaser.scale.height / 2;
        logo.anchor.setTo(0.5, 0.5);
        logo.fixedToCamera = true;
        logo.alpha = 0.75;
        this.logo = logo;

        // enable keyboard control
        this.cursors = phaser.input.keyboard.createCursorKeys();
        phaser.input.keyboard.addKeyCapture([ Phaser.Keyboard.SPACEBAR ]);

      },
      update: function(){
        var phaser = this.phaser;
        var cursors = this.cursors;
        var tank = this.tank;
        var tank_group = this.tank_group;
        var turret = this.turret;
        var land = this.land;

        var bullet
        var bullets
        var bulletTime=0

        if (cursors.left.isDown)
          tank.angle -= 4;
        else if (cursors.right.isDown)
          tank.angle += 4;
        if (cursors.up.isDown)
          tank.currentSpeed = 300;
        else
          if (tank.currentSpeed > 0)
              tank.currentSpeed -= 4;
        if (phaser.input.keyboard.SPACEBAR(phaser.keyboard.SPACEBAR))
              {
                fireBullet();
              }
        screenWrap(sprite);

        bullet.forEachExists(screenWrap, this);        

        if (tank.currentSpeed > 0)
          game.physics.arcade.velocityFromRotation(tank.rotation, tank.currentSpeed, tank.body.velocity);

        phaser.physics.arcade.collide(tank, this.layer);

        land.tilePosition.x = -game.camera.x;
        land.tilePosition.y = -game.camera.y;

        tank_group.setAll('x',tank.x)
        tank_group.setAll('y',tank.y)
        tank_group.setAll('angle',tank.angle)
        this.logo.angle = tank.angle;

        turret.rotation = game.physics.arcade.angleToPointer(turret);
      },

      fireBullet : function(){

          if (game.time.now > bulletTime)
        {
            bullet = bullets.getFirstExists(false);

            if (bullet)
            {
                bullet.reset(sprite.body.x + 16, sprite.body.y + 16);
                bullet.lifespan = 2000;
                bullet.rotation = sprite.rotation;
                game.physics.arcade.velocityFromRotation(sprite.rotation, 400, bullet.body.velocity);
                bulletTime = game.time.now + 50;
            }
        }

      },

      screenWrap : function (sprite){
            if (sprite.x < 0)
        {
            sprite.x = game.width;
        }
        else if (sprite.x > game.width)
        {
            sprite.x = 0;
        }

        if (sprite.y < 0)
        {
            sprite.y = game.height;
        }
        else if (sprite.y > game.height)
        {
            sprite.y = 0;
        }

      }
    };


    jQuery(document).ready(function($) {
      game.new($(document).width(), $(document).height(), 'game');
    });

  </script>
</body>
</html>
